google-key.json
// ========================== // package.json // ========================== // Copy this into package.json in your backend folder

/* { "name": "building-quote-backend", "version": "1.0.0", "main": "index.js", "scripts": { "start": "node index.js" }, "dependencies": { "express": "^4.18.2", "cors": "^2.8.5", "multer": "^1.4.5-lts.1", "better-sqlite3": "^8.0.0", "@google-cloud/vision": "^3.2.0", "uuid": "^9.0.0" } } */

// ========================== // index.js // ========================== // Main backend server with: // ✔ Image upload // ✔ Google Vision window detection placeholder // ✔ SQLite quotes database // ✔ Building height + window count API structure // ✔ Fully compatible with the Dockerfile you have

const express = require("express"); const cors = require("cors"); const multer = require("multer"); const { v4: uuidv4 } = require("uuid"); const Database = require("better-sqlite3"); const vision = require("@google-cloud/vision"); const path = require("path"); const fs = require("fs");

const app = express(); app.use(cors()); app.use(express.json());

// ========================== // SQLite Database Setup // ========================== const db = new Database("./data/quotes.db");

db.exec(CREATE TABLE IF NOT EXISTS quotes ( id TEXT PRIMARY KEY, address TEXT, height REAL, window_count INTEGER, price REAL, created_at TEXT ));

// ========================== // File Upload Handling // ========================== const upload = multer({ dest: "uploads/" });

// ========================== // Google Vision Client // ========================== let visionClient = null; try { visionClient = new vision.ImageAnnotatorClient(); } catch (e) { console.log("Google Vision not configured yet."); }

// ========================== // Helper: Fake AI Window Detection // Replace with real Vision logic if key is provided // ========================== async function detectWindows(imagePath) { if (!visionClient) { // Fallback demo logic return Math.floor(Math.random() * 50) + 5; }

const [result] = await visionClient.objectLocalization(imagePath); const objects = result.localizedObjectAnnotations || [];

const windows = {
  "name": "clearview-backend",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "start": "node index.js"
  },
  "dependencies": {
    "express": "^4.18.2"
  }
} => o.name.toLowerCase().includes("window")); return windows.length; }

// ========================== // API: Upload building photo and detect windows // ========================== app.post("/analyze", upload.single("photo"), async (req, res) => { try { const file = req.file; if (!file) return res.status(400).json({ error: "No file uploaded" });

const imgPath = path.join(__dirname, file.path);

const windowCount = await detectWindows(imgPath);

// Fallback height estimation (user can override in frontend)
const estimatedHeight = windowCount * 1.2;

res.json({ windowCount, estimatedHeight });

} catch (e) { console.error(e); res.status(500).json({ error: "Vision analysis failed" }); } });

// ========================== // API: Save quote to database // ========================== app.post("/quote", (req, res) => { const { address, height, windowCount, price } = req.body;

const id = uuidv4(); const created_at = new Date().toISOString();

const stmt = db.prepare( INSERT INTO quotes (id, address, height, window_count, price, created_at) VALUES (?, ?, ?, ?, ?, ?) );

stmt.run(id, address, height, windowCount, price, created_at);

res.json({ success: true, id }); });

// ========================== // API: Get all quotes // ========================== app.get("/quotes", (req, res) => { const rows = db.prepare("SELECT * FROM quotes ORDER BY created_at DESC").all(); res.json(rows); });

// ========================== // API: Status // ========================== app.get("/", (req, res) => { res.json({ status: "Backend running", version: "1.0.0" }); });

// ========================== // Start Server // ========================== const PORT = process.env.PORT || 8080; app.listen(PORT
